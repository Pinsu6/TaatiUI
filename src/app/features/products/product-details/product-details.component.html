<main class="mx-auto space-y-6">
  <!-- Loading / Error Demo Changes-->
  <div *ngIf="isLoading" class="flex justify-center items-center py-12">
    <i class="fas fa-spinner fa-spin text-2xl text-tati-burgundy mr-2"></i>
    <span>Loading product...</span>
  </div>
  <div *ngIf="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded text-center">
    {{ errorMessage }}
    <button (click)="retry()" class="ml-2 underline">Retry</button>
  </div>
  <!-- ==================== PROFILE ==================== -->
  <section *ngIf="product && !isLoading && !errorMessage" class="bg-white border shadow rounded-xl p-6 mb-6">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold text-tati-burgundy">{{ product.drugName }}</h2>
        <p class="text-gray-600 mt-1">SKU: {{ product.drugCode }}</p>
        <div class="mt-2">
          <span class="inline-flex px-3 py-1 rounded-full text-sm font-medium"
                [ngClass]="product.bitIsActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
            {{ product.bitIsActive ? 'Active' : 'Inactive' }}
          </span>
          <span *ngIf="product.isNarcotic || product.narcotics" class="inline-flex px-3 py-1 rounded-full text-sm font-medium ml-2 bg-orange-100 text-orange-800">
            Narcotic
          </span>
        </div>
      </div>
      <button (click)="goBack()"
              class="px-6 py-2 bg-tati-burgundy text-white rounded-lg hover:bg-opacity-90 transition font-medium">
        Back to List
      </button>
    </div>
    <!-- Two-column grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- LEFT – Basic info -->
      <div>
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-tati-burgundy mb-3 border-b border-gray-200 pb-2">Basic Information</h3>
          <div class="space-y-2 text-sm">
            <p><span class="font-medium text-gray-700">Quick Code:</span> <span class="text-gray-500">{{ product.drugQuickcode || 'N/A' }}</span></p>
            <p><span class="font-medium text-gray-700">Category:</span> <span class="text-gray-500">{{ product.drugTypeName || 'N/A' }}</span></p>
            <p><span class="font-medium text-gray-700">Therapeutic Class:</span> <span class="text-gray-500">{{ product.theRapeuticclass || 'N/A' }}</span></p>
            <p><span class="font-medium text-gray-700">NDC Code:</span> <span class="text-gray-500">{{ product.drugNdccode || 'N/A' }}</span></p>
            <p><span class="font-medium text-gray-700">Dosage Form:</span> <span class="text-gray-500">{{ product.dosageFormName || 'N/A' }}</span></p>
            <p><span class="font-medium text-gray-700">Brand:</span> <span class="text-gray-500">{{ product.brandName || 'N/A' }}</span></p>
            <p><span class="font-medium text-gray-700">Pack Size:</span> <span class="text-gray-500">{{ product.quantityPack || 'N/A' }}</span></p>
            <p><span class="font-medium text-gray-700">Strength:</span> <span class="text-gray-500">{{ product.strength || 'N/A' }}</span></p>
            <p><span class="font-medium text-gray-700">Manufacturer:</span> <span class="text-gray-500">{{ product.manufacturerName || 'N/A' }}</span></p>
            <p><span class="font-medium text-gray-700">Created Date:</span> <span class="text-gray-500">{{ product.dateCreated | date:'medium' }}</span></p>
          </div>
        </div>
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-tati-burgundy mb-3 border-b border-gray-200 pb-2">Description</h3>
          <p class="text-sm text-gray-600">{{ (product.drugShort || product.strength) || 'No description available.' }}</p>
        </div>
      </div>
      <!-- RIGHT – Stock & Levels -->
      <div>
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-tati-burgundy mb-3 border-b border-gray-200 pb-2">Stock & Levels</h3>
          <div class="space-y-2 text-sm">
            <p><span class="font-medium text-gray-700">Current Stock:</span> <span class="text-gray-500">{{ (product.stockSummary?.currentStock || 0) | number }}</span></p>
            <p><span class="font-medium text-gray-700">Min Level:</span> <span class="text-gray-500">{{ (product.stockSummary?.minLevel ?? product.minLevel) | number }}</span></p>
            <p><span class="font-medium text-gray-700">Max Level:</span> <span class="text-gray-500">{{ (product.stockSummary?.maxLevel ?? product.maxLevel) | number }}</span></p>
            <p><span class="font-medium text-gray-700">Total Purchased:</span> <span class="text-gray-500">{{ (product.stockSummary?.totalPurchased || 0) | number }}</span></p>
            <p><span class="font-medium text-gray-700">Total Sold:</span> <span class="text-gray-500">{{ (product.stockSummary?.totalSold || 0) | number }}</span></p>
            <p *ngIf="product.pricing" class="mt-4 pt-4 border-t border-gray-200">
              <span class="font-medium text-gray-700">Unit Cost:</span> <span class="text-gray-500">SLL {{ (product.pricing.unitCost || 0) | number:'1.2-2' }}</span>
            </p>
            <p *ngIf="product.pricing">
              <span class="font-medium text-gray-700">Sale Price:</span> <span class="text-gray-500">SLL {{ (product.pricing.salePrice || 0) | number:'1.2-2' }}</span>
            </p>
            <p *ngIf="product.pricing">
              <span class="font-medium text-gray-700">Margin:</span> <span class="text-gray-500">{{ (product.pricing.marginPercent || 0) | number:'1.2-2' }}% (SLL {{ (product.pricing.marginAmount || 0) | number:'1.2-2' }})</span>
            </p>
            <div class="mt-2">
              <span *ngIf="product.stockSummary?.isLowStock" class="inline-flex px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                Low Stock Alert
              </span>
              <span *ngIf="product.stockSummary?.isOutOfStock" class="inline-flex px-3 py-1 rounded-full text-sm font-medium ml-2 bg-red-100 text-red-800">
                Out of Stock
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>


  <!-- ==================== Manufacturer Details ==================== -->
 <!-- ==================== Manufacturer Details ==================== -->
<section *ngIf="product?.manufacturer" class="bg-white border shadow rounded-xl p-6 mb-6">
  <h3 class="text-lg font-semibold text-tati-burgundy mb-3 border-b border-gray-200 pb-2">Manufacturer Details</h3>
  <div class="space-y-2 text-sm">
    <p><span class="font-medium text-gray-700">Name:</span> <span class="text-gray-500">{{ product?.manufacturer?.manufacturerName || 'N/A' }}</span></p>
    <p><span class="font-medium text-gray-700">MFG:</span> <span class="text-gray-500">{{ product?.manufacturer?.mfg || 'N/A' }}</span></p>
    <p><span class="font-medium text-gray-700">Contact Person:</span> <span class="text-gray-500">{{ product?.manufacturer?.mfgPerson || 'N/A' }}</span></p>
    <p><span class="font-medium text-gray-700">Email:</span> <span class="text-gray-500">{{ product?.manufacturer?.mfgEmail || 'N/A' }}</span></p>
    <p><span class="font-medium text-gray-700">Mobile:</span> <span class="text-gray-500">{{ product?.manufacturer?.mfgMobile || 'N/A' }}</span></p>
  </div>
</section>

  <!-- ==================== Active Batches changes is done  ==================== -->
  <!-- ==================== Active Batches ==================== -->
<!-- ==================== Active Batches ==================== -->
<section *ngIf="product?.activeBatches?.length" class="bg-white rounded-xl shadow border-t-4 border-blue-500 mb-6">
  <div class="p-6 border-b"><h3 class="font-semibold text-blue-600">Active Batches</h3></div>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
        <tr>
          <th class="px-6 py-3">Batch No</th>
          <th class="px-6 py-3">Expiry Date</th>
          <th class="px-6 py-3">Remaining Qty</th>
          <th class="px-6 py-3">Status</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        <tr *ngFor="let batch of product?.activeBatches">
          <td class="px-6 py-3">{{ batch.batchNo }}</td>
          <td class="px-6 py-3">{{ batch.expiryDate | date:'medium' }}</td>
          <td class="px-6 py-3">{{ batch.remainingQty | number }}</td>
          <td class="px-6 py-3" [ngClass]="batch.isExpiringSoon ? 'text-red-600' : 'text-green-600'">
            {{ batch.isExpiringSoon ? 'Expiring Soon' : 'Active' }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

  <!-- ==================== KPIs ==================== -->
  <section *ngIf="product" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="bg-white p-6 rounded-xl shadow border-t-4 border-tati-burgundy">
      <h3 class="text-gray-500">Total Sold</h3>
      <p class="text-2xl font-bold text-tati-burgundy">{{ (product.stockSummary?.totalSold || 0) | number }}</p>
    </div>
    <div class="bg-white p-6 rounded-xl shadow border-t-4 border-green-500">
      <h3 class="text-gray-500">Total Revenue</h3>
      <p class="text-2xl font-bold text-green-600">SLL {{ formattedTotalRevenueM }}</p>
    </div>
    <div class="bg-white p-6 rounded-xl shadow border-t-4 border-blue-500">
      <h3 class="text-gray-500">Current Stock</h3>
      <p class="text-2xl font-bold text-blue-600">{{ (product.stockSummary?.currentStock || 0) | number }}</p>
    </div>
    <div class="bg-white p-6 rounded-xl shadow border-t-4 border-yellow-500">
      <h3 class="text-gray-500">Turnover Rate</h3>
      <p class="text-2xl font-bold text-yellow-600">{{ formattedTurnoverRate }}</p>
    </div>
  </section>
  <!-- ==================== Charts ==================== -->
  <section *ngIf="product" class="mb-6">
    <div class="bg-white p-6 rounded-xl shadow border-t-4 border-tati-burgundy">
      <h3 class="font-semibold text-tati-burgundy mb-4">Monthly Sales Trend</h3>
      <div class="chart-container"><canvas #salesTrend></canvas></div>
    </div>
  </section>
  <!-- ==================== Recent Orders ==================== -->
  <section *ngIf="product" class="bg-white rounded-xl shadow border-t-4 border-blue-500 mb-6">
    <div class="p-6 border-b"><h3 class="font-semibold text-blue-600">Recent Orders Containing this Product</h3></div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
          <tr><th class="px-6 py-3">Order ID</th><th class="px-6 py-3">Date</th>
              <th class="px-6 py-3">Customer</th><th class="px-6 py-3">Qty</th><th class="px-6 py-3">Total</th></tr>
        </thead>
        <tbody class="divide-y">
          <tr *ngFor="let o of pagedOrders">
            <td class="px-6 py-3">{{ o.orderId }}</td>
            <td class="px-6 py-3">{{ o.date | date:'medium' }}</td>
            <td class="px-6 py-3">{{ o.customer }}</td>
            <td class="px-6 py-3">{{ o.quantity | number }}</td>
            <td class="px-6 py-3">{{ formatOrderTotal(o.total) }}</td>
          </tr>
          <tr *ngIf="orders.length === 0"><td colspan="5" class="px-6 py-3 text-center text-gray-600">No orders yet.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- ==== PAGINATION (match customers) ==== -->
    <div *ngIf="totalCount > 0" class="flex justify-between items-center bg-white rounded-xl p-4 border-t">
      <!-- LEFT: page size + showing text -->
      <div class="flex items-center gap-4 text-sm text-gray-600">
        <select [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange()"
                class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-tati-burgundy outline-none">
          <option *ngFor="let size of pageSizes" [value]="size">{{ size }} per page</option>
        </select>

        <span>
          Showing {{ (pageNumber-1)*pageSize + 1 }} -
          {{ pageNumber*pageSize > totalCount ? totalCount : pageNumber*pageSize }}
          of {{ totalCount }} orders
        </span>
      </div>

      <!-- RIGHT: page buttons -->
      <div class="flex items-center gap-2">
        <button (click)="previousPage()" [disabled]="!hasPreviousPage"
                class="px-4 py-2 border rounded-lg disabled:opacity-50 hover:bg-gray-100">
          Previous
        </button>

        <button *ngFor="let p of getVisiblePages()" (click)="goToPage(p)"
                [class.bg-tati-burgundy]="p === pageNumber" [class.text-white]="p === pageNumber"
                class="px-4 py-2 border rounded-lg hover:bg-gray-100">
          {{ p }}
        </button>

        <span *ngIf="totalPages > 5 && getVisiblePages()[4] < totalPages" class="px-4 py-2">
          ... {{ totalPages }}
        </span>

        <button (click)="nextPage()" [disabled]="!hasNextPage"
                class="px-4 py-2 border rounded-lg disabled:opacity-50 hover:bg-gray-100">
          Next
        </button>
      </div>
    </div>
  </section>
  <!-- ==================== Stock Movements ==================== -->
  <section *ngIf="product" class="bg-white rounded-xl shadow border-t-4 border-yellow-500 mb-6">
    <div class="p-6 border-b"><h3 class="font-semibold text-yellow-600">Stock Movements</h3></div>
    <div class="p-6">
      <ul class="list-disc ml-5 text-gray-700">
        <li *ngFor="let m of stockMovements">
          <span *ngIf="m.date">{{ m.date | date:'medium' }}: </span>
          <span>{{ m.description || m.type || 'Stock movement' }}</span>
          <span *ngIf="m.quantity"> ({{ m.quantity | number }} units)</span>
        </li>
        <li *ngIf="stockMovements.length === 0" class="text-gray-600">No movements recorded.</li>
      </ul>
    </div>
  </section>
  <!-- ==================== Regional Sales ==================== -->
  <section *ngIf="(product?.regionalSales?.length ?? 0) > 0" class="bg-white rounded-xl shadow border-t-4 border-purple-500 mb-6">
    <div class="p-6 border-b"><h3 class="font-semibold text-purple-600">Regional Sales</h3></div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
          <tr>
            <th class="px-6 py-3">Region</th>
            <th class="px-6 py-3">Quantity</th>
            <th class="px-6 py-3">Amount</th>
          </tr>
        </thead>
        <tbody class="divide-y">
          <tr *ngFor="let region of product!.regionalSales">
            <td class="px-6 py-3">{{ region.region }}</td>
            <td class="px-6 py-3">{{ region.quantity | number }}</td>
            <td class="px-6 py-3">SLL {{ region.amount | number:'1.2-2' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ==================== Promotions / Alerts ==================== -->
  <section *ngIf="product" class="bg-white rounded-xl shadow border-t-4 border-red-500">
    <div class="p-6 border-b"><h3 class="font-semibold text-red-600">Promotions & Alerts</h3></div>
    <div class="p-6">
      <p class="text-gray-700 mb-2" *ngFor="let a of alerts">{{ a.message }}</p>
      <p *ngIf="alerts.length === 0" class="text-gray-600">No alerts at the moment.</p>
    </div>
  </section>
</main>
